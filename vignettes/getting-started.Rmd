---
title: "getting-started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{getting-started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE # Don't evaluate code chunks - this is a usage guide
)
```

```{r setup}
library(climate.risk.tool)

# Set the path to your data directory
# This should contain:
# - user_input/asset_information.csv
# - user_input/company.csv
# - hazards/[hazard_type]/*.tif or *.nc files (supports both formats)
# - damage_and_cost_factors.csv
# - precomputed_adm_hazards.csv (precomputed hazard statistics for regions)
# - hazards_name_mapping.csv (metadata for TIF hazards, optional for NC)
base_dir <- file.path("..", "tests", "tests_data")
```

## Prepare inputs

Load all required data from your base directory:

```{r}
# Load all required data
assets <- read_assets(base_dir)
companies <- read_companies(file.path(base_dir, "user_input", "company_small.csv"))

# Load hazards with unified loader (supports both TIF and NetCDF formats)
hazard_data <- load_hazards_and_inventory(file.path(base_dir, "hazards"), aggregate_factor = 16L)
hazards <- c(hazard_data$hazards$tif, hazard_data$hazards$nc, hazard_data$hazards$csv) # Flatten for compute_risk
hazards_inventory <- hazard_data$inventory

# Load precomputed hazard statistics for administrative regions
precomputed_hazards <- read_precomputed_hazards(base_dir)
damage_factors <- read_damage_cost_factors(base_dir)
```

## Explore hazard inventory

Before defining events, let's examine what hazards are available:

```{r}
# Display available hazards for user selection (reusing already loaded data)
inventory <- hazard_data$inventory

# Show summary of available hazard types
cat("Available Hazard Types:\n")
print(inventory |> dplyr::group_by(hazard_type, source) |>
  dplyr::summarise(count = dplyr::n(), .groups = "drop"))

# Show detailed inventory for user selection
cat("\nDetailed Hazard Inventory (first 10 rows):\n")
print(inventory |> head(10))

# Show all available hazard names for reference
cat("\nAll Available Hazard Names (for copy-paste in events):\n")
cat("TIF Hazards:\n")
cat(paste(names(hazard_data$hazards$tif), collapse = "\n"))
cat("\n\nNC Hazards (base names, ensemble expansion happens automatically):\n")
nc_base_names <- unique(sub("__ensemble=.*$", "", names(hazard_data$hazards$nc)))
cat(paste(nc_base_names, collapse = "\n"))
```

## Define events

Define the climate scenarios you want to analyze. You can mix different hazard types:

```{r}
# Create events mixing flood and drought hazards
  events <- data.frame(
    hazard_type = c("FloodTIF", "FloodTIF", "Compound", "Compound"),
    hazard_name = c(
      "FloodTIF__Flood Height__GWL=CurrentClimate__RP=10",
      "FloodTIF__Flood Height__GWL=CurrentClimate__RP=10",
      # Compound CSV hazards use indicator 'HI' (Heat Index) in our data
      "Compound__HI__GWL=present__RP=10__ensemble=mean",
      "Compound__HI__GWL=3__RP=10__ensemble=mean"
    ),
    scenario_name = c("CurrentClimate", "CurrentClimate", "present", "3"),
    hazard_return_period = c(10, 10, 10, 10),
    event_year = c(2030L, NA_integer_, 2030L, 2035L),
    chronic = c(FALSE, TRUE, FALSE, FALSE),
    stringsAsFactors = FALSE
  )
```

## Run the model

Run the complete climate risk analysis pipeline:

```{r}
# Run the complete climate risk analysis
results <- compute_risk(
  assets = assets,
  companies = companies,
  events = events,
  hazards = hazards,
  hazards_inventory = hazards_inventory,
  precomputed_hazards = precomputed_hazards,
  damage_factors = damage_factors,
  growth_rate = 0.02,
  net_profit_margin = 0.1,
  discount_rate = 0.05
)
```



## Explore results

The results object contains multiple dataframes with different levels of detail:

### Assets hazard exposure and damage factors

Shows how each asset is exposed to different hazards:

```{r}
results$assets_factors
```

### Assets yearly profits trajectory

Detailed year-by-year profit projections for each asset under different scenarios:

```{r}
results$assets_yearly
```

### Companies yearly profits trajectory

Aggregated year-by-year profit projections at the company level:

```{r}
results$companies_yearly
```

### Assets aggregated financials

Summary NPV metrics for each asset by scenario:

```{r}
results$assets
```

### Companies aggregated financials

Final company-level risk metrics including NPV, Probability of Default (PD), and Expected Loss:

```{r}
results$companies
```

## New Features: NetCDF Support

The package now supports NetCDF (.nc) files in addition to GeoTIFF (.tif) files:

### NetCDF Hazard Files

NetCDF files provide several advantages:
- **Pre-computed ensemble statistics** (mean, median, p10, p90) - no spatial computation needed
- **Multiple variables per file** with automatic variable selection
- **Auto-discovery** from directory structure and file dimensions

### Hazard Data Formats

**GeoTIFF (.tif) Files** (Traditional)
- Require `hazards_name_mapping.csv` for metadata
- Spatial extraction computes statistics from pixel values
- Naming: `flood__rcp85_h100glob`

**NetCDF (.nc) Files** (New)
- Auto-discover from directory structure: `hazards/{hazard_type}/{indicator}/{model_type}/`
- Direct extraction of pre-computed statistics
- Naming: `CDD__ensemble__GWL=unknown__RP=10__ensemble=mean`

### Ensemble Expansion

For NetCDF hazards, the `filter_hazards_by_events()` function automatically expands base event names to include ALL ensemble variants:

- Input: `"CDD__ensemble__GWL=unknown__RP=10"` (base event name)
- Expands to: 4 rasters (mean, median, p10, p90)
- Enables complete statistics extraction without spatial computation

This expansion happens automatically - you only need to specify the base event name without the final `__ensemble=` suffix.

### Updated Function Signatures

Key functions have been updated to support both data formats:

- `load_hazards_and_inventory()` - Unified loader for TIF + NC files
- `compute_risk()` - Now requires `hazards_inventory` parameter
- `filter_hazards_by_events()` - Smart filtering with ensemble expansion
- `extract_hazard_statistics()` - Dual workflow for TIF vs NC sources



